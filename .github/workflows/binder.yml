on:
  check_suite:
    type: ['completed']

permissions:
  packages: write
  contents: write

name: Build binder image
jobs:
  binder:
    name: Build Binder Image
    if: >-
      github.event.check_suite.app.name == 'Cirrus CI'
      && github.event.check_suite.conclusion == 'success'
      && github.event.check_suite.head_branch == 'main'
      && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout notebook branch
      uses: actions/checkout@v3
      with:
        ref: out
        fetch-depth: 0
    - name: repo2docker
      uses: jupyterhub/repo2docker-action@master
      with:
        DOCKER_REGISTRY: ghcr.io
        DOCKER_USERNAME: ${{ github.repository_owner }}
        DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        BINDER_CACHE: true
        PUBLIC_REGISTRY_CHECK: true
