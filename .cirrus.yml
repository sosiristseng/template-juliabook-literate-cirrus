jupyter_book_task:
  execution_lock: $CIRRUS_BRANCH
  env:
    NPROC: 1
    GH_TOKEN: ENCRYPTED[a83a3d33c85c1d0439cbfdb99f81551f87b7bfc3de072a36822d8019ef5f7d5a4aa6c7f47c975db2afa3a3c60f24384d]
    GKSwstype: 100
    JULIA_PROJECT: $CIRRUS_WORKING_DIR
  auto_cancellation: true
  container:
    dockerfile: .github/Dockerfile
    cpu: 1
    memory: 4G
    greedy: true
  literate_script: julia --color=yes -p $NPROC literate.jl
  upload_notebook_script: |
    if [[ $CIRRUS_BRANCH == $CIRRUS_DEFAULT_BRANCH ]]; then
      echo "Uploading notebooks"
      echo ".cirrus.yml" >> .gitignore
      echo ".github/" >> .gitignore
      git remote set-url origin https://${GH_TOKEN}@github.com/${CIRRUS_REPO_FULL_NAME}.git
      ghp-import -nofpb out $CIRRUS_WORKING_DIR
    fi
  jbook_script: jupyter-book build docs/ --keep-going
  ## Requires a repo scope access GitHub PAT encrypted to `GH_TOKEN` to push to its GitHub repo
  pages_script: |
    if [[ $CIRRUS_BRANCH == $CIRRUS_DEFAULT_BRANCH ]]; then
      echo "Deploying to GitHub pages"
      git remote set-url origin https://${GH_TOKEN}@github.com/${CIRRUS_REPO_FULL_NAME}.git
      ghp-import -nofp docs/_build/html
    fi
